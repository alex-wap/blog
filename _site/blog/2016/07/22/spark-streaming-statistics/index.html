<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <meta name=viewport content="width=device-width, initial-scale=1.0">
        <meta name=description content="Blog of Emaad Ahmed Manzoor">
        
        <title>
          
            Spark Streaming Microbatch Metrics, Programmatically via the REST API | 
          
          Emaad Ahmed Manzoor
        </title>

        <script src=http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML.js type=text/javascript></script>
        <script>
            MathJax.Hub.Config({
              "HTML-CSS": {
                linebreaks: {
                    automatic: true,
                    width: "70% container"
                },
                styles: {
                    ".MathJax .math": {
                        //"border": "1px solid #ccc",
                        //"margin": "0.1em 0",
                        //"padding": "0.3em",
                        //"vertical-align": "middle"
                    },
                    ".MathJax_Display .math": {
                        "border": "none",
                        "padding": "0",
                    }
                },
                scale: 100
              }
            });
        </script>
                
        <link rel=stylesheet type=text/css href=/css/pure-min.css>
        <link rel=stylesheet type=text/css href=/css/github.css>
        <link rel=stylesheet type=text/css href=/css/styles.css>
        <link rel=stylesheet type=text/css href=/css/font-awesome/css/font-awesome.min.css>
        
        <link rel=alternate type=application/rss+xml title="RSS feed for eyeshalfclosed.com" href="/feed.xml">
    </head>
    <body>
        <div class="container pure-g-r">
            <div class=pure-u-1-4>
                <div class=author-info>
    <img src="/images/author-image.jpeg" class=author-image />
    <h1 class=author-name><a href=/>Emaad Ahmed Manzoor</a></h1>
    <div class=nav>
        <a href="https://github.com/emaadmanzoor"><i class=icon-github-alt></i></a>
        <a href="https://twitter.com/emaadmanzoor"><i class=icon-twitter></i></a>
        <a href="https://linkedin.com/in/emaadmanzoor"><i class=icon-linkedin></a></i>
        <a href="http://feeds.feedburner.com/eyeshalfclosed"><i class=icon-rss></i></a>
    </div>
    <div class=home-nav>
        <ul>
            <li><a href="https://scholar.google.com/citations?user=TcMyxM0AAAAJ">Scholar</a></li>
            <li><a href="/blog/">Blog</a>
                &nbsp;|&nbsp;
                <a href="/jrnl/">jrnl</a></li>
            <li><a href="/projects/">Projects</a>
                &nbsp;|&nbsp;
                <a href="https://github.com/emaadmanzoor">Code</a>
            </li>
            <li><a href="/talks/">Talks</a></li>
            <li><a href="/service/">Service</a></li>
            <li><a href="/teaching/">Teaching</a></li>
            <li>
                <a class=resume-link href="/cv.pdf">CV</a><br/>
                <span class=resume-update>(Updated Mar. '19)</span>
            </li>
        </ul>
    </div>
</div>

            </div>
            <div class=pure-u-3-4>
                <div class=right-column>
                    <div class=post>
    
    <ul class=post-meta>
    
    <li class=publish-time><i class=icon-calendar></i>July 22, 2016</li>
    
        <li>&middot;</li>
        <li><a href="/tags/#distributed-systems-ref">#distributed-systems</a></li>
    
</ul>

    <h1 class=title-large>Spark Streaming Microbatch Metrics, Programmatically via the REST API</h1>
    <div class=content>
        <p><em>TLDR; <a href="https://gist.github.com/emaadmanzoor/cc12763a4133ca30fad8be065846ecc4">metric collection script</a>.</em></p>

<p>The Spark Streaming web UI shows a number of interesting metrics over time.
<a href="http://www3.cs.stonybrook.edu/~tnle/">Tan</a> and I were specifically interested
in the (micro)batch start times, processing times and scheduling delays, which we
could find no reported way of obtaining programmatically. We were running Spark
2.0.0 on YARN 2.7.2 in cluster-mode.</p>

<p>All I could find with was this <a href="http://stackoverflow.com/questions/34507578/how-to-fetch-spark-streaming-job-statistics-using-rest-calls-when-running-in-yar">StackOverflow question</a>
that suggested scraping the Spark UI webpage (as, horribly, <a href="https://github.com/amitsing89/pythonscripts/blob/master/sparkMonitoring.py">some have done</a>)
or hitting the JSON API endpoint at <code class="highlighter-rouge">/api/v1/</code>. This endpoint, unfortunately again,
does not provide the same metrics we see on the Spark Streaming web UI.</p>

<p>Not directly.</p>

<p>It turns out that you can use the <code class="highlighter-rouge">/jobs/</code> endpoint to reconstruct the metrics you
see on the Spark Streaming web UI: the batch start time, processing delay and
scheduling delay. The key to how this reconstruction is done lies in the
<a href="https://github.com/apache/spark/blob/d6dc12ef0146ae409834c78737c116050961f350/streaming/src/main/scala/org/apache/spark/streaming/scheduler/BatchInfo.scala">BatchInfo class definition</a> 
in the Spark codebase.</p>

<p>I wrote a <a href="https://gist.github.com/emaadmanzoor/cc12763a4133ca30fad8be065846ecc4">script</a>
that parses the JSON from this endpoint and reconstructs these metrics, given the
application ID (the one YARN generates for you on submission) and the YARN master
URL. All times are in seconds. A sample execution is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python get_spark_streaming_batch_statistics.py <span class="se">\</span>
  <span class="nt">--master</span> ec2-52-40-144-150.us-west-2.compute.amazonaws.com <span class="se">\</span>
  <span class="nt">--applicationId</span> application_1469205272660_0006
</code></pre></div></div>

<p>Sample output (batch start-time, processing time, scheduling delay):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  18:36:55 3.991 3783.837
  18:36:56 4.001 3786.832
  18:36:57 3.949 3789.862
  ...
</code></pre></div></div>

<p>The script creates a map from each batch to its start time and all the jobs it
contains, along with the jobsâ€™ start and completion times. Simple arithmetic then
generates the required metrics. It is easy to modify the script to print the
actual timestamps instead of the delay, if one wishes to.</p>

<p>Do file an <a href="https://github.com/lenhattan86/ccra/issues">issue</a> with any
questions or contributions you have.</p>

    </div>
</div>

                </div>
            </div>
        </div>
    </body>
</html>
